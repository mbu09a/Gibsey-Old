# Week 1 — Day 7 (Vault Stub + Sprint Retro)

> **Target session:** ≈ 3 h (2 h build + 1 h reflection)
>
> **Focus:** ① create the `vault` table, `/vault/save` endpoint, and a minimal React call; ② hold a 30‑minute retrospective to lock lessons learned and recalibrate Week 2.
>
> **Outcome:** pressing **Save to Vault** stores the Q\&A pair in Postgres, and you exit Week 1 with a clear view of what worked and what slips to Week 2.

---

## 0 · Schema — add `vault` table

Open Supabase SQL editor and run:

```sql
create table if not exists vault (
  id        bigint generated by default as identity primary key,
  user_id   uuid      default '00000000-0000-0000-0000-000000000000', -- anon for now
  page_id   bigint references pages(id) on delete cascade,
  question  text,
  answer    text,
  created_at timestamp with time zone default now()
);

-- optional basic index for later querying
create index if not exists idx_vault_user_ts on vault(user_id, created_at desc);
```

No vector column yet; you’ll decide later if the Vault gets its own embeddings.

---

## 1 · Backend — `/vault/save` route

### 1.1  DTOs

Append to `app/schemas.py`:

```python
class VaultSaveRequest(BaseModel):
    page_id: int
    question: str
    answer: str
```

### 1.2  Route

In `app/main.py`:

```python
from .schemas import VaultSaveRequest

@app.post("/vault/save", status_code=201)
async def save_to_vault(req: VaultSaveRequest):
    Supabase.client() \
        .table("vault") \
        .insert({
            "page_id": req.page_id,
            "question": req.question,
            "answer": req.answer,
        }) \
        .execute()
    return {"ok": True}
```

No auth yet; anonymous user for Week 1.
Re‑build & up backend:

```bash
docker compose -f infra/compose.yaml build backend && docker compose up -d backend
```

---

## 2 · Frontend — Save button

### 2.1  API helper

`src/lib/api.ts` — add:

```ts
export async function saveVault(page_id: number, q: string, a: string) {
  const base = import.meta.env.VITE_API_BASE;
  const r = await fetch(`${base}/vault/save`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ page_id, question: q, answer: a }),
  });
  if (!r.ok) throw new Error("Vault save failed");
}
```

### 2.2  UI update

In `src/App.tsx` under the block that renders `answer`, append:

```tsx
{answer && (
  <button
    onClick={() => saveVault(1, question, answer)}
    className="mt-2 px-3 py-1 bg-amber-600 text-white rounded"
  >
    Save to Vault
  </button>
)}
```

Commit:

```bash
git add src/lib/api.ts src/App.tsx
git commit -m "feat: vault save stub"
```

---

## 3 · Manual smoke test

1. Refresh **localhost:5173**.
2. Load shard → Ask question → After answer appears, click **Save to Vault**.
3. In Supabase SQL editor:

```sql
select id, question, left(answer,40)||'…' as ans_preview
from vault order by id desc limit 3;
```

Row should be present.

Latency impact: negligible (< 20 ms insert).

---

## 4 · CI — no change required

Push branch & PR:

```bash
git push -u origin day7-vault-stub
```

Link PR to **“Day 7 – Vault stub + retro”** → merge green → move card to *Done*.

---

## 5 · 30‑min Sprint Retro

*(Block calendar immediately after coding.)*

| Prompt                          | Write in README‑W1.md §Retro                                  |
| ------------------------------- | ------------------------------------------------------------- |
| **What went well?**             | list ≥ 3 concrete wins (e.g., “Docker skeleton never broke”). |
| **What puzzled or slowed you?** | max 3 bullets (e.g., “Supabase Python client docs unclear”).  |
| **Scope changes?**              | note any tasks that slipped to Week 2 column.                 |
| **Latency check:**              | record average `/ask` ms from DevTools.                       |
| **Emotional battery:**          | 1–5 rating, gut‑feel.                                         |

Commit retro note:

```bash
git add README-W1.md
git commit -m "docs: add Week 1 retro"
```

---

### ✅ End-of-Day 7 Definition

* `vault` table + `/vault/save` functional.
* React button triggers insert; verified in DB.
* Week 1 retro committed.
* GitHub Project: all Week 1 cards in *Done* or moved to Week 2 column.

> **Congrats 🏁** — you now have a clickable, database‑backed Read → Ask → Save loop in six nights. Week 2 will tackle multiple shards, real embeddings in `/ask`, and beginning the Vault timeline UI.
