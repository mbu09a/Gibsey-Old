# Week 7 — Day 44 (Vault Edit Endpoint & UI Modal)

> **Target session:** ≈ 3 h  **Goal:** allow users to edit a saved Vault entry’s question or answer. Provide an **Edit** icon per item, open a modal with markdown textarea, save via `/vault/update`, and reflect changes in realtime timeline. Keep an audit copy in a new `vault_history` table.
>
> **Outcome:** Clicking ✏️ opens modal, editing text → Save updates row instantly (Supabase Realtime). Undo history retained server‑side.

---

## 1 · Database — `vault_history` table

```sql
create table if not exists vault_history (
  id          bigint generated by default as identity primary key,
  vault_id    bigint references vault(id) on delete cascade,
  user_id     uuid,
  old_q       text,
  old_a       text,
  ts          timestamptz default now()
);
```

RLS: same policies as `vault` (owner only).

---

## 2 · Backend — `/vault/update`

### 2.1 Pydantic model

```python
class VaultUpdateRequest(BaseModel):
    id: int
    question: str
    answer: str
```

### 2.2 Route

```python
@app.post("/vault/update", status_code=200)
async def vault_update(req: VaultUpdateRequest, user: User = Depends(get_current_user)):
    # fetch existing row (auth via RLS)
    row = sb.table("vault").select("question,answer").eq("id", req.id).eq("user_id", user.id).single().execute().data
    if not row:
        raise HTTPException(404, "Not found")
    # write history
    sb.table("vault_history").insert({
        "vault_id": req.id,
        "user_id": user.id,
        "old_q": row["question"],
        "old_a": row["answer"]
    }).execute()
    # update row
    sb.table("vault").update({"question": req.question, "answer": req.answer, "updated_at": datetime.utcnow()}).eq("id", req.id).execute()
    return {"ok": True}
```

Ensure RLS policy on `vault` allows update when `user_id = auth.uid()`.

---

## 3 · Front‑end — Edit modal

### 3.1 Icon button

In `VaultEntry.tsx` card component:

```tsx
import { Pencil } from "lucide-react";
...
<button onClick={()=>setEditing(entry)} className="p-1" aria-label="Edit entry"><Pencil size={16}/></button>
```

### 3.2 EditModal component

```tsx
function EditModal({ entry, onClose }){
  const [q,setQ]=useState(entry.question);
  const [a,setA]=useState(entry.answer);
  const save = async ()=>{
    await apiFetch("/vault/update", {method:"POST", body: JSON.stringify({id: entry.id, question:q, answer:a})});
    toast.success("Saved");
    onClose();
  };
  return <Dialog.Root open onOpenChange={c=>!c&&onClose()}>
    <Dialog.Content className="bg-white dark:bg-zinc-900 p-6 rounded-md w-[90vw] max-w-lg">
      <h2 className="font-semibold mb-2">Edit Vault Entry</h2>
      <label className="text-sm">Question</label>
      <textarea value={q} onChange={e=>setQ(e.target.value)} rows={2} className="w-full border p-2 rounded-md"/>
      <label className="text-sm mt-4 block">Answer (Markdown)</label>
      <textarea value={a} onChange={e=>setA(e.target.value)} rows={6} className="w-full border p-2 rounded-md"/>
      <div className="flex justify-end gap-2 mt-4">
        <button onClick={onClose} className="px-3 py-1">Cancel</button>
        <button onClick={save} className="bg-emerald-600 text-white px-4 py-1 rounded-md">Save</button>
      </div>
    </Dialog.Content>
  </Dialog.Root>;
}
```

Open modal when `editing` state set; on close, Supabase Realtime broadcast triggers timeline reactive update (already subscribed).

---

## 4 · Supabase Realtime channel (ensure update events)

If not enabled, toggle **RLS** broadcast for `vault` table triggers. Front‑end `useEffect` already handles `on('UPDATE')`.

---

## 5 · Tests & CI

* Add Pytest hitting `/vault/update` with wrong user → 404.
* Update bench script to exclude `/vault/update` calls.

---

## 6 · Manual QA

1. Edit question text → Save → timeline reflects.
2. Check history table row count increases.
3. Another user cannot edit your entry (returns 404).
4. P95 latency unchanged (log `X-Route-Timing`).

---

## 7 · Commit & PR

```bash
git checkout -b day44-vault-edit
# add backend route, modal component, tests
git add apps/backend apps/frontend
git commit -m "feat: vault edit endpoint + modal with audit history"
git push -u origin day44-vault-edit
```

PR → **Closes #Day-44 issue** → merge when CI passes; move card to **Done**.

---

### ✅ End-of-Day 44 Definition

* `/vault/update` live with audit trail.
* Edit icon & modal save entries; realtime timeline refresh.
* Latency unaffected (bench P90 ≤ 2 s).

*Tomorrow (Day 45):* implement delete + undo flow with soft‑delete flag.